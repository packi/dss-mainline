CMAKE_MINIMUM_REQUIRED (VERSION 2.6)
PROJECT(DSS)

OPTION(WITH_TESTS "Include test-suite" ON)
OPTION(WITH_SIM "Compile and start the simulation" ON)
IF(NOT WITH_DATADIR)
	SET(WITH_DATADIR "data/" CACHE FILEPATH "Data directory")
ENDIF(NOT WITH_DATADIR)


INCLUDE (${CMAKE_ROOT}/Modules/FindLibXml2.cmake)
IF (LIBXML2_FOUND)
	INCLUDE_DIRECTORIES (${LIBXML2_INCLUDE_DIR})
	LINK_LIBRARIES (${LIBXML2_LIBRARIES})
ELSE (LIBXML2_FOUND)
	MESSAGE (FATAL_ERROR "Cannot build without LibXML2. Please install
	LibXML2.")
ENDIF (LIBXML2_FOUND)

ADD_DEFINITIONS(-DXP_UNIX -DUSE_LIBXML -DNO_CGI)
ADD_DEFINITIONS(-Wall -Werror)
INCLUDE_DIRECTORIES(external)
INCLUDE_DIRECTORIES(${DSS_SOURCE_DIR})

IF(${CMAKE_SYSTEM_NAME} MATCHES "Darwin")
  INCLUDE_DIRECTORIES(/opt/local/include)
  SET(CMAKE_REQUIRED_INCLUDES ${CMAKE_REQUIRED_INCLUDES} /opt/local/include)
  LINK_DIRECTORIES(/opt/local/lib)
  LINK_LIBRARIES(boost_filesystem-mt boost_system-mt boost_program_options-mt PocoFoundation PocoNet)
  SET(DNS_SD_LIB)
ELSE(${CMAKE_SYSTEM_NAME} MATCHES "Darwin")
  LINK_LIBRARIES(boost_filesystem-mt boost_system-mt boost_program_options-mt rt)
ENDIF(${CMAKE_SYSTEM_NAME} MATCHES "Darwin")

IF(${CMAKE_SYSTEM_NAME} MATCHES "Linux")
  INCLUDE(CheckCXXCompilerFlag)
  CHECK_CXX_COMPILER_FLAG("-Wno-depreceated" HAVE_WNO_DEPRECATED)
  IF(HAVE_WNO_DEPRECATED)
    SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wno-deprecated")
  ENDIF(HAVE_WNO_DEPRECATED)
ENDIF(${CMAKE_SYSTEM_NAME} MATCHES "Linux")

LINK_LIBRARIES(PocoFoundation PocoNet)

# header tests
INCLUDE(CheckIncludeFiles)

# check for SpiderMonkey API header
SET(CMAKE_REQUIRED_DEFINITIONS ${CMAKE_REQUIRED_DEFINITIONS} -DXP_UNIX)
CHECK_INCLUDE_FILES(mozjs/jsapi.h HAVE_MOZJS_JSAPI_H)
CHECK_INCLUDE_FILES(js/jsapi.h HAVE_JS_JSAPI_H)

CHECK_INCLUDE_FILES(libical/ical.h HAVE_LIBICAL_ICAL_H)
CHECK_INCLUDE_FILES(ical.h HAVE_ICAL_H)

CHECK_INCLUDE_FILES(dns_sd.h HAVE_DNS_SD)
CHECK_INCLUDE_FILES(avahi-client/publish.h HAVE_AVAHI)

IF(${HAVE_AVAHI} MATCHES 1) 
  SET(DNS_SD_LIB avahi-common avahi-client)
  SET(WITH_BONJOUR)
ELSE(${HAVE_AVAHI} MATCHES 1)
ENDIF(${HAVE_AVAHI} MATCHES 1)

IF(${HAVE_DNS_SD} MATCHES 1)
  SET(WITH_BONJOUR)
  IF(NOT ${CMAKE_SYSTEM_NAME} MATCHES "Darwin")
    SET(DNS_SD_LIB dns_sd)
  ENDIF(NOT ${CMAKE_SYSTEM_NAME} MATCHES "Darwin")
ELSE(${HAVE_DNS_SD} MATCHES 1)
ENDIF(${HAVE_DNS_SD} MATCHES 1)


# check for SpiderMonkey Library
FIND_LIBRARY(MOZJS mozjs)
IF(${MOZJS} MATCHES "MOZJS-NOTFOUND")
  FIND_LIBRARY(MOZJS js)
ENDIF(${MOZJS} MATCHES "MOZJS-NOTFOUND")

# set default data directory



# generate config.h header file
CONFIGURE_FILE(${CMAKE_CURRENT_SOURCE_DIR}/config.h.in
               ${CMAKE_CURRENT_BINARY_DIR}/config.h)
ADD_DEFINITIONS(-DHAVE_CONFIG_H)
INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR})

ADD_SUBDIRECTORY(core)
ADD_SUBDIRECTORY(unix)
ADD_SUBDIRECTORY(webservices)
ADD_SUBDIRECTORY(external)
ADD_SUBDIRECTORY(doc)

LINK_DIRECTORIES(${DSS_BINARY_DIR}/core ${DSS_BINARY_DIR}/unix ${DSS_BINARY_DIR}/tests)

SET(BOOST_TEST_LIB)
SET(TEST_LIB)
IF(WITH_TESTS) 
  ADD_SUBDIRECTORY(tests)
  SET(BOOST_TEST_LIB boost_unit_test_framework-mt)
  SET(TEST_LIB tests)
ENDIF(WITH_TESTS)

ADD_EXECUTABLE(dss main.cpp namespaces.cpp)

LINK_LIBRARIES(gsoap++)

TARGET_LINK_LIBRARIES(dss ${TEST_LIB} core unix webservices pthread shttpd
	ical dl PocoXML ${MOZJS} ${DNS_SD_LIB} ${BOOST_TEST_LIB})
