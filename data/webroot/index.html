<html>
  <head>
    <title>digitalStrom - Server</title>
	<script src="prototype.js" language="JavaScript" type="text/javascript"></script>
	<link rel="stylesheet" type="text/css" href="main.css"/>
	<script type="text/javascript" language="JavaScript">
	
	function turnOn(devid) {
	  new Ajax.Request('/json/turnon', 
	    {
	      method:'get', 
	      parameters: {device: devid},
          onComplete: function(transport, json) {
            doUpdate();
          }
	    } 
	  );
	}
	
	function turnOff(devid) {
	  new Ajax.Request('/json/turnoff',
	    {
	      method:'get', 
	      parameters: {device: devid},
          onComplete: function(transport, json) {
            doUpdate();
          }
	    } 
	  );
	}
	
	function update(devices) {
	  $('numDevs').innerHTML = devices.length;
	  var devslist = "<h2>Devices</h2><table>";
	  devslist += "<tr><th>Name</th><th>State</th><th>Actions</th></tr>"
	  devices.each(function(dev) {
	    devslist += "<tr><td>" + dev.name + "</td>";
		if(dev.on) {
		  devslist += "<td>On</td>";
		} else {
		  devslist += "<td>Off</td>";
		}
	    devslist += '<td><a href="#" onclick="turnOn(' + dev.id + ')">Turn On</a>';
	    devslist += '&nbsp;<a href="#" onclick="turnOff(' + dev.id + ')">Turn Off</a></td>';
	    devslist += "</tr>";	    
	  });
	  
	  devslist += "</table>";
	  $('devList').innerHTML = devslist;
	}
	
	function doUpdate() {
  	  new Ajax.Request(
	    '/json/getdevices', 
	    { method:'get',
          onComplete: function(transport, json) {
            update(transport.responseJSON.devices);
          }
        }
	  );
	}
	
	function raiseEvent() {
	  new Ajax.Request('/json/event/raise',
	    {
	      method:'get', 
	      parameters: 
	        { 
	          evtid: $F('evtid'),
	          sourceid: $F('eventsrc')
	        }
	    } 
	  );
	}
	
	function scheduleEvent() {
	  new Ajax.Request('/json/event/schedule',
	    {
	      method:'get', 
	      parameters: 
	        { 
	          evtid: $F('evtid'),
	          sourceid: $F('eventsrc'),
	          schedule: $F('eventsched'),
	          start: $F('eventstart'),
	          name: $F('evtname')
	        },
	      onComplete: function(transport, json) {
	        updateEvents();
	      }
	    } 
	  );
	}
	
	function deleteEvent(id) {
	  new Ajax.Request('/json/event/remove',
	    {
	      method: 'get',
	      parameters:
	        {
	          id: id
	        },
	      onComplete: function(transport, json) {
	        updateEvents();
	      }
	    }
	  );
	}
	
	function updateEventList(events) {
	  var eventlist = "<h2>Scheduled events</h2><ol>";
	  events.each(
	    function(event) {
	      eventlist += "<li>" +  event.name + ' <a href="#" onclick="deleteEvent(' + event.id + ')">Remove</a></li>';
	    }
	  );
	  eventlist += "</ol>";
	  $('evt_div').innerHTML = eventlist;
	}
	
	function updateEvents() {
	  new Ajax.Request('/json/event/getlist',
	    {
	       method: 'get',
	       onComplete: function(transport, json) {
	         updateEventList(transport.responseJSON.events);
	       }
	    }
	  ); 
	}
	
	function unsubscribeFrom(id) {
	  new Ajax.Request('/json/subscription/unsubscribe',
	    {
	      method: 'get',
	      parameters:
	        {
	          id: id
	        },
	      onComplete: function(transport, json) {
	        updateSubscriptions();
	      }
	    }
	  );
	}
	
    function updateSubscriptionsList(subscriptions) {
	  var subscriptionlist = "<h2>Subscriptions</h2><table>";
	  subscriptionlist += "<tr><th>Name</th><th>ID</th><th>Action</th></tr>";
	  subscriptions.each(
	    function(subscription) {
	      subscriptionlist += "<tr><td>" + subscription.name + "</td><td>" + subscription.id + '</td><td><a href="#" onclick="unsubscribeFrom(' + subscription.id + ')">Unsubscribe</a></td></tr>';
	    }
	  );
	  subscriptionlist += "</table>";
	  $('sub_div').innerHTML = subscriptionlist;
	}
	
	
	function updateSubscriptions() {
	  new Ajax.Request('/json/subscription/getlist',
	    {
	      method: 'get',
	      onComplete: function(transport, json) {
	        updateSubscriptionsList(transport.responseJSON.subscriptions);
	      }
	    }
	  );
	}
	
	function subscribe() {
	  new Ajax.Request('/json/subscription/subscribe',
	    {
	      method: 'get',
	      parameters:
	        {
	          evtids: $F('sub_evtids'),
	          sourceids: $F('sub_sourceid'),
	          action: $F('action_name'),
	          file: $F('param_file')
	        },
	      onComplete: function(transport, json) {
	        updateSubscriptions();
	      }
	    }
	  );
	}
  
	doUpdate();	
	updateEvents();
	updateSubscriptions();
</script>
  </head>
  <body>
    <h1>Welcome to the dSS!</h1>
    <div class="container">
		<div class="item"><a href="config">Config</a></div>
		<div class="item">Connected devices: <span id="numDevs">(...loading...)</span></div>
	</div>
	<div class="container fl">
	<form>
	<h2>Event Raising / Scheduling</h2>
	<table>
	  <tr><td>Event ID:</td><td><input type="text" id="evtid" value="1001"/></td></tr>
	  <tr><td>Event Source:</td><td><input type="text" id="eventsrc" value="1"/></td></tr>
	  <tr><td>Event Schedule:</td><td><input type="text" id="eventsched" value="FREQ=MINUTELY;INTERVAL=2"/></td></tr>
	  <tr><td>Event Start:</td><td><input type="text" id="eventstart" value="20080520T080000"/></td></tr>
	  <tr><td>Event Name:</td><td><input type="text" id="evtname" value="testing..."/></td></tr>
	  <tr><td><a href="#" onclick="raiseEvent()">Raise</a>
	  <a href="#" onclick="scheduleEvent()">Schedule</a></td></tr>
	  </table>
	</form>
	</div>

	<div id="devList" class="container fl">
	(...loading...)
	</div>
	<div id="evt_div" class="container fl">
	(...loading...)
	</div>
	<div id="sub_div" class="container fl">
	(...loading...)
	</div>	
	
	<div class="container fl">
	<form>
	  <h2>Subscription</h2>
	  <table>
	    <tr><td>Event IDs</td><td><input type="text" id="sub_evtids" value="1001"/></td></tr>
	    <tr><td>Source IDs</td><td><input type="text" id="sub_sourceid" value=""/></td></tr>
	    <tr>
	      <td>Action</td>
	      <td>
	        <select id="action_name">
	          <option value="none">(please choose)</option>
	          <option value="actionJS">Execute JavaScript</option>
	        </select>
	      </td>
	    </tr>
	    <tr><td>Parameter[file]</td><td><input type="text" id="param_file"></td></tr>
	    <tr><td><a href="#" onclick="subscribe()">Subscribe</td><td></td></tr>
      </table>
	</form>
	</div>
  </body>	
</html>