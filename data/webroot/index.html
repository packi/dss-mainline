<html>
  <head>
    <title>digitalStrom - Server</title>
<script type="text/javascript" language="JavaScript">
function onModelLoaded() {
}
</script>
	<script src="js/lib/prototpye/prototype.js" language="JavaScript" type="text/javascript"></script>
  <script src="js/switch.js" language="JavaScript" type="text/javascript"></script>
	<script src="js/model.js" language="JavaScript" type="text/javascript"></script>
	<link rel="stylesheet" type="text/css" href="main.css"/>
	<script type="text/javascript" language="JavaScript">

function ApartmentRenderer(into) {
  var self = this;
  self.apartment = new Apartment();
  self.apartment.fetch();

  this.render = function() {
    var iSwitch = 0;
    var switchIDs = [];
    var devNum = 0;
    var devTotal = 0;

    var zonelist = "<ul>"
    self.apartment.zones.each(
      function(zone) {
        if(zone.id == 0) {
          devTotal = zone.devices.length;
          return;
        }
        zonelist += "<li>" + zone.name + '&nbsp;[<a href="#" onclick="turnOnZone(\'' + zone.id + '\')">Turn On</a>';
        zonelist += '&nbsp;|&nbsp;<a href="#" onclick="turnOffZone(\'' + zone.id + '\')">Turn Off</a>]</li><ul>';
        zone.devices.each(function(device) {
          if(device.isPresent) {
            zonelist += '<li><p title="fid:' + device.fid + ' circuitID: ' + device.circuitID + ' busID: ' + device.busID + '">' + device.name;
            devNum++;
            if(!device.isSwitch()) {
              if(device.isOn()) {
                zonelist += ' <span id="state_' + device.dsid + '"><b>On</b></span> ';
              } else {
                zonelist += ' <span id="state_' + device.dsid + '"><b>Off</b></span> ';
              }
              zonelist += '[<a href="#" onclick="turnOn(\'' + device.dsid + '\')">Turn On</a>';
              zonelist += '&nbsp;|&nbsp;<a href="#" onclick="turnOff(\'' + device.dsid + '\')">Turn Off</a>] ' + device.dsid;
            } else {
              zonelist += '<div id="switch_' + device.dsid + '"/>';
              switchIDs[switchIDs.length] = { id: device.dsid, zoneID: zone.id };
            }

            zonelist += "</p></li>";
          }
        });
        zonelist += "</ul>";
      }
    );
    zonelist += "</ul>";
    $(into).innerHTML = zonelist;


    switchIDs.each(function(switchID) {
      var sw = new Switch('switch_' + switchID.id, switchID.id, switchID.zoneID, 1 );
    });
    var hiddenDevs = devTotal - devNum;
    if(hiddenDevs > 0) {
      $('numDevs').innerHTML = devTotal + ' (' + hiddenDevs + ' hidden)';
    } else {
      $('numDevs').innerHTML = devTotal;
    }
  }

}

var apt = null;


	function turnOn(devid) {
	  var dev = new Device(devid);
	  dev.turnOn();
      setTimeout(function() { updateDevice(devid); }, 100);
	}

	function turnOff(devid) {
	  var dev = new Device(devid);
	  dev.turnOff();
      setTimeout(function() { updateDevice(devid); }, 100);
	}

	function turnOnZone(zoneid) {
      var zone = new Zone(zoneid);
      zone.turnOn();
      setTimeout(function() { updateZone(zoneid); }, 100);
	}

	function turnOffZone(zoneid) {
	  var zone = new Zone(zoneid);
	  zone.turnOff();
      setTimeout(function() { updateZone(zoneid); }, 100);
	}
	
	function update(_setSpec) {
	  var set = new Set(_setSpec);
	  var devs = set.getDevices();
	  devs.each(function(device) {
	    if(device.isPresent) {
  	      var htmlString;
          if(device.on) {
            htmlString = '<b>On</b>';
          } else {
            htmlString = '<b>Off</b>';
          }
          $('state_' + device.id).innerHTML = htmlString;
        }
	  });
	}
	
	function updateZone(zoneid) {
	  update(".zone(" + zoneid + ")");
	}

	function updateDevice(dsid) {
	  update(".dsid(" + dsid + ")");
	}

    function doOnload() {
      apt = new ApartmentRenderer("bla");
      apt.render();
    }
</script>
  </head>
  <body onload="doOnload()">
    <h1>Welcome to the dSS!</h1>
    <div class="container">
		<div class="item"><a href="browse/">Browse properties</a></div>
		<div class="item">Connected devices: <span id="numDevs">(...loading...)</span></div>
	</div>
	<div class="container">
        <div id="bla">(loading...)</div>
	</div>
  </body>
</html>
