<html>
  <head>
    <title>digitalStrom - Server</title>
<script type="text/javascript" language="JavaScript">
function onModelLoaded() {
}
</script>
	<script src="js/prototype.js" language="JavaScript" type="text/javascript"></script>
  <script src="js/switch.js" language="JavaScript" type="text/javascript"></script>
	<script src="js/model.js" language="JavaScript" type="text/javascript"></script>
	<link rel="stylesheet" type="text/css" href="main.css"/>
	<script type="text/javascript" language="JavaScript">

function ApartmentRenderer(into) {
  var self = this;
  self.apartment = new Apartment();
  self.apartment.fetch();

  this.render = function() {
    var iSwitch = 0;
    var switchIDs = [];
    var devNum = 0;
    var devTotal = 0;

    var zonelist = "<ul>"
    self.apartment.zones.each(
      function(zone) {
        if(zone.id == 0) {
          devTotal = zone.devices.length;
          return;
        }
        zonelist += "<li>" + zone.name + '[<a href="#" onclick="turnOnZone(\'' + zone.id + '\')">Turn On</a>';
        zonelist += '&nbsp;|&nbsp;<a href="#" onclick="turnOffZone(\'' + zone.id + '\')">Turn Off</a>]</li><ul>';
        zone.devices.each(function(device) {
          zonelist += '<li><p title="fid:' + device.fid + ' circuitID: ' + device.circuitID + ' busID: ' + device.busID + '">' + device.name;
          devNum++;
          if(!device.isSwitch()) {
            if(device.isOn()) {
              zonelist += " On ";
            } else {
              zonelist += " Off ";
            }
            zonelist += '[<a href="#" onclick="turnOn(\'' + device.dsid + '\')">Turn On</a>';
            zonelist += '&nbsp;|&nbsp;<a href="#" onclick="turnOff(\'' + device.dsid + '\')">Turn Off</a>] ' + device.dsid;
          } else {
            zonelist += '<div id="switch_' + device.dsid + '"/>';
            switchIDs[switchIDs.length] = { id: device.dsid, zoneID: zone.id };
          }

          zonelist += "</p></li>";
        });
        zonelist += "</ul>";
      }
    );
    zonelist += "</ul>";
    $(into).innerHTML = zonelist;


    switchIDs.each(function(switchID) {
      var sw = new Switch('switch_' + switchID.id, switchID.id, switchID.zoneID, 1 );
    });
    var hiddenDevs = devTotal - devNum;
    if(hiddenDevs > 0) {
      $('numDevs').innerHTML = devTotal + ' (' + hiddenDevs + ' hidden)';
    } else {
      $('numDevs').innerHTML = devTotal;
    }
  }

}

var apt = null;


	function turnOn(devid) {
	  new Device(devid).turnOn();
//new HEvent('turnOn', '.dsid(0000000000000000ffc00004)', undefined).raise();
	}

	function turnOff(devid) {
	  new Device(devid).turnOff();
	}

	function turnOnZone(zoneid) {
    new Zone(zoneid).turnOn();
         // var z = new Zone(zoneid);
         // z.sendEvent('turnOn');
	  //new Zone(zoneid).sendEvent('turnoOn');
	}

	function turnOffZone(zoneid) {
	  new Zone(zoneid).turnOff();
	}

function doOnload() {
  apt = new ApartmentRenderer("bla");
  apt.render();
}
</script>
  </head>
  <body onload="doOnload()">
    <h1>Welcome to the dSS!</h1>
    <div class="container">
		<div class="item"><a href="config">Config</a>&nbsp;<a href="http://localhost:8080/json/event/raise?name=bell">Bell</a></div>
		<div class="item">Connected devices: <span id="numDevs">(...loading...)</span></div>
	</div>
	<div class="container">
        <div id="bla">(loading...)</div>
	</div>
  </body>
</html>
